name: Release SDK

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g. v1.2.3)"
        required: true
        type: string

permissions:
  contents: write        # needed to push commits/tags and create/edit releases
  pull-requests: write   # needed to create and merge pull requests

concurrency: # to avoid race conditions
  group: release
  cancel-in-progress: false

jobs:
  release:
    runs-on: macos-26
    environment:
      name: Only Main
    timeout-minutes: 15
    outputs:
      merge_sha: ${{ steps.create_pr.outputs.merge_sha }}

    defaults:
      run:
        shell: bash --noprofile --norc -euo pipefail {0}

    env:
      SCHEME: Nubrick
      WORKSPACE: Nubrick.xcworkspace
      FRAMEWORK_NAME: Nubrick
      XCFRAMEWORK_NAME: Nubrick.xcframework
      ZIP_NAME: Nubrick.xcframework.zip
      OUTPUT_DIR: Nubrick/output
      TAG: ${{ inputs.version }}
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout (full)
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          ref: main

      - name: Show available Xcodes
        run: ls /Applications
  
      - name: Select Xcode 16.4
        run: sudo xcode-select -s "/Applications/Xcode_16.4.app/Contents/Developer"

      - name: Confirm Xcode version
        run: |
          xcodebuild -version
          swift --version

      - name: Validate version format
        run: |
          if ! echo "$TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "ERROR: Version must be in format vX.X.X (e.g., v1.2.3), got: $TAG" >&2
            exit 1
          fi
          echo "Version format valid: $TAG"

      - name: Check tag does not exist
        run: |
          git fetch --tags
          if git tag -l | grep -q "^${TAG}$"; then
            echo "ERROR: Tag $TAG already exists" >&2
            exit 1
          fi
          echo "Tag $TAG does not exist. Proceeding..."

      - name: Install sentry-cli
        run: brew install sentry-cli

      - name: Build framework
        run: |
          cd Nubrick
          sh ./create_xcframework.sh

      - name: Upload symbols to Sentry
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          sentry-cli debug-files upload --project nubrick-ios --include-sources ${OUTPUT_DIR}/${XCFRAMEWORK_NAME}

      - name: Create zip file
        run: |
          cp LICENSE "${OUTPUT_DIR}/"
          cd "${OUTPUT_DIR}"
          zip -r -X "${ZIP_NAME}" "${XCFRAMEWORK_NAME}" LICENSE

      - name: Compute checksum
        id: checksum
        run: |
          SHA=$(swift package compute-checksum "${OUTPUT_DIR}/${ZIP_NAME}")
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      # --- Create/ensure a DRAFT release for this tag (no tag yet) and upload asset ---
      - name: Prepare draft release (auto-generate notes)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view "$TAG" >/dev/null 2>&1; then
            # Release exists â€” check draft state
            IS_DRAFT=$(gh release view "$TAG" --json isDraft --jq '.isDraft')
            if [ "$IS_DRAFT" = "true" ]; then
                echo "Draft release '$TAG' already exists. Proceeding without changes."
            else
                echo "ERROR: Release '$TAG' already published. Aborting." >&2
                exit 1
            fi
          else
            # Create a new draft (auto-generated notes), pointing at the dispatch commit
            gh release create "$TAG" \
                --draft \
                --title "$TAG" \
                --target "$GITHUB_SHA" \
                --generate-notes
            echo "Created draft release '$TAG'."
          fi

      - name: Upload asset to draft release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "$TAG" "${OUTPUT_DIR}/${ZIP_NAME}" --clobber

      # --- Configure git user ---
      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # --- Create release branch ---
      - name: Create release branch
        run: |
          BRANCH_NAME="release/${TAG}"

          # Check if branch already exists remotely
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" >/dev/null 2>&1; then
            echo "ERROR: Branch $BRANCH_NAME already exists" >&2
            exit 1
          fi

          # Create new branch
          git checkout -b "$BRANCH_NAME"

      # --- Update Package.swift, Nubrick.podspec, and SDK version ---
      - name: Update Package.swift, Nubrick.podspec, and SDK version
        env:
          URL: "https://github.com/${{ github.repository }}/releases/download/${{ env.TAG }}/${{ env.ZIP_NAME }}"
          SHA: ${{ steps.checksum.outputs.sha }}
          VERSION: ${{ inputs.version }}
        run: |
          # Update SDK version in source code
          VERSION_NUMBER="${VERSION#v}"  # strip leading 'v'
          sed -i '' "s|\(public let nubrickSdkVersion = \"\)[^\"]*\(\"\)|\1${VERSION_NUMBER}\2|" Sources/Nubrick/sdk.swift
          echo "Updated SDK version to $VERSION_NUMBER"

          # Update Package.swift
          perl -0777 -i -pe '
            my ($u,$s) = @ENV{qw/ URL SHA/};

            # Find ONE .binaryTarget( ... ) block that contains name: "Nubrick"
            s{
                (\.binaryTarget\(
                (?:
                    (?!\)\s*[,)]).        # any char that is NOT the start of a closing paren line
                )*?
                name:\s*"Nubrick"        # must contain name: "Nubrick" (escaped safely)
                (?:
                    (?!\)\s*[,)]).        
                )*?
                \))
            }{
                my $blk = $1;             # capture the whole block text we matched
                # Inside the block, replace url: "..." and checksum: "..."
                $blk =~ s/(url:\s*")[^"]*(")/$1$u$2/s;
                $blk =~ s/(checksum:\s*")[^"]*(")/$1$s$2/s;
                $blk;                     # return the modified block as the replacement
            }egsx;
            ' Package.swift

          # Update Nubrick.podspec
          sed -i '' "s|\(spec\.version[[:space:]]*=[[:space:]]*\"\)[^\"]*\(\"\)|\1${VERSION_NUMBER}\2|" Nubrick.podspec
          sed -i '' "s|\(:http[[:space:]]*=>[[:space:]]*\"\)[^\"]*\(\"\)|\1${URL}\2|" Nubrick.podspec
          sed -i '' "s|\(:sha256[[:space:]]*=>[[:space:]]*\"\)[^\"]*\(\"\)|\1${SHA}\2|" Nubrick.podspec
          echo "Updated Nubrick.podspec: version=$VERSION_NUMBER, URL, and SHA256"

          git add Sources/Nubrick/sdk.swift
          git add Package.swift
          git add Nubrick.podspec
          git commit -m "[bot] Release ${TAG}: update version, Package.swift, and Nubrick.podspec"

      - name: Validate Package.swift syntax
        run: swift package dump-package > /dev/null

      - name: Show diffs
        run: git --no-pager diff HEAD~1 -- Sources/Nubrick/sdk.swift Package.swift Nubrick.podspec || true

      - name: Push release branch and create PR
        id: create_pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH_NAME="release/${TAG}"
          git push origin "$BRANCH_NAME"

          # Create PR and enable auto-merge
          PR_URL=$(gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "Release ${TAG}" \
            --body "Automated release PR for ${TAG}")

          echo "Created PR: $PR_URL"

          # Enable auto-merge (requires branch protection rules to allow it)
          gh pr merge "$BRANCH_NAME" --auto --squash || gh pr merge "$BRANCH_NAME" --auto --merge

          echo "Waiting for PR to be merged..."
          # Wait for PR to be merged (max 5 minutes)
          for i in {1..60}; do
            if gh pr view "$BRANCH_NAME" --json state --jq '.state' | grep -q "MERGED"; then
              echo "PR merged successfully"

              # Get the merge commit SHA
              MERGE_SHA=$(gh pr view "$BRANCH_NAME" --json mergeCommit --jq '.mergeCommit.oid')
              echo "merge_sha=$MERGE_SHA" >> "$GITHUB_OUTPUT"
              echo "Merge commit: $MERGE_SHA"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "ERROR: PR was not merged within 5 minutes" >&2
              exit 1
            fi
            sleep 5
          done

      # --- Create the tag on main and publish the release ---
      - name: Create tag and publish release
        env:
          GH_TOKEN: ${{ github.token }}
          MERGE_SHA: ${{ steps.create_pr.outputs.merge_sha }}
        run: |
          # Fetch the merge commit
          git fetch origin "$MERGE_SHA"
          git checkout "$MERGE_SHA"

          # Create tag on the merged commit
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

          # Publish the release pointing to the merge commit
          gh release edit "$TAG" --draft=false --target "$MERGE_SHA"

      - name: Publish to Cocoapods
        run: |
          pod trunk push --verbose Nubrick.podspec
        env:
            COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}

      - name: Verify public URL + checksum
        env:
          URL: "https://github.com/${{ github.repository }}/releases/download/${{ env.TAG }}/${{ env.ZIP_NAME }}"
          EXPECTED_SHA: ${{ steps.checksum.outputs.sha }}
        run: |
          echo "Fetching $URL"
          curl -L --fail --retry 5 --retry-delay 2 -o /tmp/artifact.zip "$URL"
          ACTUAL_SHA=$(shasum -a 256 /tmp/artifact.zip | awk '{print $1}')
          test "$ACTUAL_SHA" = "$EXPECTED_SHA" || {
            echo "Checksum mismatch! expected=$EXPECTED_SHA actual=$ACTUAL_SHA"
            exit 1
          }
          echo "Public URL reachable and checksum OK."

  # Run tests and E2E after release is published since they were skipped during release
  test:
    needs: release
    uses: ./.github/workflows/test-ios.yaml
    with:
      ref: ${{ needs.release.outputs.merge_sha }}

  e2e:
    needs: release
    uses: ./.github/workflows/e2e.yaml
    secrets: inherit
    with:
      ref: ${{ needs.release.outputs.merge_sha }}
