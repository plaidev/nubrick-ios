name: Release SDK

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g. v1.2.3)"
        required: true
        type: string
      branch:
        description: "Branch to release from"
        required: false
        type: string
        default: "main"

permissions:
  contents: write    # needed to push commits/tags and create/edit releases

concurrency: # to avoid race conditions
  group: release
  cancel-in-progress: false

jobs:
  release:
    runs-on: macos-26
    environment:
      name: Only Main
    timeout-minutes: 15

    defaults:
      run:
        shell: bash --noprofile --norc -euo pipefail {0}

    env:
      SCHEME: Nubrick
      WORKSPACE: Nubrick.xcworkspace
      FRAMEWORK_NAME: Nubrick
      XCFRAMEWORK_NAME: Nubrick.xcframework
      ZIP_NAME: Nubrick.xcframework.zip
      OUTPUT_DIR: Nubrick/output
      TAG: ${{ inputs.version }}
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout (full)
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          ref: ${{ inputs.branch }}

      - name: Validate version format
        run: |
          if ! echo "$TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "ERROR: Version must be in format vX.X.X (e.g., v1.2.3), got: $TAG" >&2
            exit 1
          fi
          echo "Version format valid: $TAG"

      - name: Xcode version
        run: |
          xcodebuild -version
          swift --version

      - name: Install sentry-cli
        run: brew install sentry-cli

      - name: Build framework
        run: |
          cd Nubrick
          sh ./create_xcframework.sh

      - name: Upload symbols to Sentry
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          sentry-cli debug-files upload --project nubrick-ios --include-sources ${OUTPUT_DIR}/${XCFRAMEWORK_NAME}

      - name: Create zip file
        run: |
          zip -r -X "${OUTPUT_DIR}/${ZIP_NAME}" "${OUTPUT_DIR}/${XCFRAMEWORK_NAME}" LICENSE

      - name: Compute checksum
        id: checksum
        run: |
          SHA=$(swift package compute-checksum "${OUTPUT_DIR}/${ZIP_NAME}")
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      # --- Create/ensure a DRAFT release for this tag (no tag yet) and upload asset ---
      - name: Prepare draft release (auto-generate notes)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view "$TAG" >/dev/null 2>&1; then
            # Release exists â€” check draft state
            IS_DRAFT=$(gh release view "$TAG" --json draft --jq '.draft')
            if [ "$IS_DRAFT" = "true" ]; then
                echo "Draft release '$TAG' already exists. Proceeding without changes."
            else
                echo "ERROR: Release '$TAG' already published. Aborting." >&2
                exit 1
            fi
          else
            # Create a new draft (auto-generated notes), pointing at the dispatch commit
            gh release create "$TAG" \
                --draft \
                --title "$TAG" \
                --target "$GITHUB_SHA" \
                --generate-notes
            echo "Created draft release '$TAG'."
          fi

      - name: Upload asset to draft release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "$TAG" "${OUTPUT_DIR}/${ZIP_NAME}" --clobber

      # --- Update Package.swift, Nubrick.podspec, and SDK version ---
      - name: Update Package.swift, Nubrick.podspec, and SDK version
        env:
          URL: "https://github.com/${{ github.repository }}/releases/download/${{ env.TAG }}/${{ env.ZIP_NAME }}"
          SHA: ${{ steps.checksum.outputs.sha }}
          VERSION: ${{ inputs.version }}
        run: |
          # Update SDK version in source code
          VERSION_NUMBER="${VERSION#v}"  # strip leading 'v'
          sed -i '' "s|\(public let nubrickSdkVersion = \"\)[^\"]*\(\"\)|\1${VERSION_NUMBER}\2|" Sources/Nubrick/sdk.swift
          echo "Updated SDK version to $VERSION_NUMBER"

          # Update Package.swift
          perl -0777 -i -pe '
            my ($u,$s) = @ENV{qw/ URL SHA/};

            # Find ONE .binaryTarget( ... ) block that contains name: "Nubrick"
            s{
                (\.binaryTarget\(
                (?:
                    (?!\)\s*[,)]).        # any char that is NOT the start of a closing paren line
                )*?
                name:\s*"Nubrick"        # must contain name: "Nubrick" (escaped safely)
                (?:
                    (?!\)\s*[,)]).        
                )*?
                \))
            }{
                my $blk = $1;             # capture the whole block text we matched
                # Inside the block, replace url: "..." and checksum: "..."
                $blk =~ s/(url:\s*")[^"]*(")/$1$u$2/s;
                $blk =~ s/(checksum:\s*")[^"]*(")/$1$s$2/s;
                $blk;                     # return the modified block as the replacement
            }egsx;
            ' Package.swift

          # Update Nubrick.podspec
          sed -i '' "s|\(spec\.version[[:space:]]*=[[:space:]]*\"\)[^\"]*\(\"\)|\1${VERSION_NUMBER}\2|" Nubrick.podspec
          sed -i '' "s|\(:http[[:space:]]*=>[[:space:]]*\"\)[^\"]*\(\"\)|\1${URL}\2|" Nubrick.podspec
          sed -i '' "s|\(:sha256[[:space:]]*=>[[:space:]]*\"\)[^\"]*\(\"\)|\1${SHA}\2|" Nubrick.podspec
          echo "Updated Nubrick.podspec: version=$VERSION_NUMBER, URL, and SHA256"

          git add Sources/Nubrick/sdk.swift
          git add Package.swift
          git add Nubrick.podspec
          git commit -m "Release ${TAG}: update version, Package.swift, and Nubrick.podspec"

      - name: Validate Package.swift syntax
        run: swift package dump-package > /dev/null

      - name: Show diffs
        run: git --no-pager diff HEAD~1 -- Sources/Nubrick/sdk.swift Package.swift Nubrick.podspec || true

      - name: Push to ${{ inputs.branch }}
        run: |
          git push origin HEAD:${{ inputs.branch }}

      # --- Create the tag at this commit and publish the release ---
      - name: Create and push tag
        run: |
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Verify git tag matches podspec version
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          PODSPEC_VERSION=$(cat ./Nubrick.podspec | grep -E 's\.version\W+=' | grep -o -e '[0-9]\.[0-9]\.[0-9]')
          test "$TAG_VERSION" = "$PODSPEC_VERSION"
  
      - name: Publish to Cocoapods
        run: |
          pod trunk push --verbose Nubrick.podspec
        env:
            COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}

      - name: Publish release (attach tag to this commit)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git fetch origin ${{ inputs.branch }}
          TARGET_SHA=$(git rev-parse origin/${{ inputs.branch }})
          gh release edit "$TAG" --draft=false --target "$TARGET_SHA"

      - name: Verify public URL + checksum
        env:
          URL: "https://github.com/${{ github.repository }}/releases/download/${{ env.TAG }}/${{ env.ZIP_NAME }}"
          EXPECTED_SHA: ${{ steps.checksum.outputs.sha }}
        run: |
          echo "Fetching $URL"
          curl -L --fail --retry 5 --retry-delay 2 -o /tmp/artifact.zip "$URL"
          ACTUAL_SHA=$(shasum -a 256 /tmp/artifact.zip | awk '{print $1}')
          test "$ACTUAL_SHA" = "$EXPECTED_SHA" || {
            echo "Checksum mismatch! expected=$EXPECTED_SHA actual=$ACTUAL_SHA"
            exit 1
          }
          echo "Public URL reachable and checksum OK."
